<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambit AI - Web Interface</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Top Corner Settings -->
        <div class="top-settings">
            <button class="corner-btn top-left" id="voiceSettingsBtn">
                üé§ Voice
            </button>
            <button class="corner-btn" id="infoBtn">
                ‚ÑπÔ∏è Info
            </button>
            <button class="corner-btn top-right" id="advancedToggle">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <div class="header">
            <h1>ü§ñ Ambit AI</h1>
            <p>One-Click Conversational AI Assistant</p>
        </div>

        <!-- Main Panel -->
        <div class="main-panel">
            <!-- Audio Visualization -->
            <div class="audio-viz-container" id="audioViz">
                <canvas id="audioCanvas"></canvas>
                <div class="viz-overlay" id="vizOverlay">
                    <span>üéµ Audio Visualizer</span>
                </div>
            </div>

            <!-- Conversation Panel - Right under audio viz -->
            <div class="conversation-panel">
                <h3>üí¨ Conversation</h3>
                
                <div class="conversation-log" id="conversationLog">
                    <div class="message-system">[System] Welcome to Ambit AI</div>
                    <div class="message-system">[System] Click "Start Conversation" to begin</div>
                </div>

                <div class="quick-input">
                    <input type="text" id="messageInput" placeholder="Type your message here..." disabled>
                    <button id="sendBtn" class="send-btn" disabled>Send</button>
                </div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="primary-controls">
                    <button id="startConvoBtn" class="start-conversation-btn">
                        üöÄ Start Conversation
                    </button>
                    
                    <div class="secondary-controls">
                        <button id="resetConvoBtn" class="control-btn reset-btn" disabled>
                            üîÑ Reset Conversation
                        </button>
                        <button id="clearLogBtn" class="control-btn clear-btn" disabled>
                            üóëÔ∏è Clear Log
                        </button>
                    </div>
                </div>
                
                <div class="status-indicator" id="statusIndicator">
                    <span class="connection-dot dot-disconnected"></span>
                    Ready to start - Click above to begin
                </div>
            </div>
        </div>
    </div>

    <!-- Modals - Moved outside the container to fix stacking context issues -->
    <div class="voice-settings-panel" id="voiceSettingsPanel">
        <div class="modal-header">
            <h4>üé§ Voice Selection</h4>
            <button class="modal-close-btn" onclick="app.closeAllModals()">‚úï</button>
        </div>
        <div class="voice-options">
            <div class="preset-voices">
                <h5>Preset Voices</h5>
                <div class="voice-grid">
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="1F0HEz1i7DetoXlB32Yy" checked>
                        <span class="voice-name">AMBIT (Default)</span>
                        <span class="voice-description">The official voice of Ambit.</span>
                    </label>
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="YOq2y2Up4RgXP2HyXjE5">
                        <span class="voice-name">Deep Monster</span>
                        <span class="voice-description">Dark and intimidating</span>
                    </label>
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="yjJ45q8TVCrtMhEKurxY">
                        <span class="voice-name">Mad Scientist</span>
                        <span class="voice-description">Eccentric and brilliant</span>
                    </label>
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="d2dPVWorYGa7CSQb2jt3">
                        <span class="voice-name">Kyle</span>
                        <span class="voice-description">The original creator.</span>
                    </label>
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="YXpFCvM1S3JbWEJhoskW">
                        <span class="voice-name">Cowboy</span>
                        <span class="voice-description">Rugged and confident</span>
                    </label>
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="oR4uRy4fHDUGGISL0Rev">
                        <span class="voice-name">Old Wizard</span>
                        <span class="voice-description">Wise and mystical</span>
                    </label>
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="KKOYIrvUAjNXYCKUyxhh">
                        <span class="voice-name">Anon</span>
                        <span class="voice-description">Anonymous voice</span>
                    </label>
                    <label class="voice-option">
                        <input type="radio" name="voicePreset" value="f2yUVfK5jdm78zlpcZ8C">
                        <span class="voice-name">Funny Nerd</span>
                        <span class="voice-description">Quirky and humorous</span>
                    </label>
                </div>
            </div>
            
            <div class="custom-voice-section">
                <h5>Custom Voice ID</h5>
                <div class="custom-voice-input">
                    <label class="voice-option custom-option">
                        <input type="radio" name="voicePreset" value="custom">
                        <span class="voice-name">Custom Voice</span>
                    </label>
                    <input type="text" id="customVoiceId" placeholder="Enter your custom voice ID..." disabled>
                </div>
            </div>
        </div>
        
        <div class="voice-settings-actions">
            <button id="applyVoiceBtn" class="apply-voice-btn">Apply Voice</button>
            <button id="closeVoiceBtn" class="close-voice-btn">Close</button>
        </div>
    </div>

    <div class="advanced-settings" id="advancedSettings">
        <div class="modal-header">
            <h4>‚öôÔ∏è Advanced Configuration</h4>
            <button class="modal-close-btn" onclick="app.closeAllModals()">‚úï</button>
        </div>
        
        <div class="settings-section">
            <h5>API Keys Override</h5>
            <div class="settings-grid">
                <div class="setting-item">
                    <label for="openaiApiKey">OpenAI API Key</label>
                    <input type="password" id="openaiApiKey" placeholder="sk-...">
                    <small>Override default OpenAI API key</small>
                </div>
                <div class="setting-item">
                    <label for="elevenlabsApiKey">ElevenLabs API Key</label>
                    <input type="password" id="elevenlabsApiKey" placeholder="Enter your ElevenLabs API key">
                    <small>Override default ElevenLabs API key</small>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h5>Custom Instructions</h5>
            <div class="setting-item full-width">
                <label for="customInstructions">Additional Prompt Instructions</label>
                <textarea id="customInstructions" rows="4" placeholder="Add your own custom instructions to modify Ambit's behavior...&#10;&#10;Example: 'Always respond in a cheerful tone' or 'Focus on technical details when explaining concepts'"></textarea>
                <small>These instructions will be added to Ambit's system prompt</small>
            </div>
        </div>

        <div class="advanced-actions">
            <button id="saveAdvancedBtn" class="save-advanced-btn">üíæ Save Settings</button>
            <button id="resetAdvancedBtn" class="reset-advanced-btn">üîÑ Reset to Defaults</button>
        </div>
        
        <div class="save-indicator" id="saveIndicator">
            <span class="save-message">‚úÖ Settings saved successfully!</span>
        </div>
    </div>

    <!-- Info Panel Modal -->
    <div class="info-panel" id="infoPanel">
        <div class="modal-header">
            <h4>‚ùì Quick Guide</h4>
            <button class="modal-close-btn" onclick="app.closeAllModals()">‚úï</button>
        </div>
        <div class="info-content">
            <h2>Welcome to Ambit AI</h2>
            <p>This guide explains the main features and how to use them.</p>

            <div class="info-section">
                <h3>üöÄ Core Conversation</h3>
                <ul>
                    <li><strong>Start/Stop:</strong> Use the main "Start Conversation" button to begin or end your session.</li>
                    <li><strong>Voice Input:</strong> When a conversation is active, the AI is listening. Simply speak, and it will automatically detect your speech.</li>
                    <li><strong>Text Input:</strong> You can type messages in the input box at any time during a conversation.</li>
                    <li><strong>Interruption:</strong> You can interrupt Ambit while it's speaking by simply starting to talk.</li>
                </ul>
            </div>

            <div class="info-section">
                <h3>üõ†Ô∏è Settings & Customization</h3>
                <ul>
                    <li><strong>üé§ Voice Settings:</strong> Click the "Voice" button to choose from preset voices or provide a custom ElevenLabs Voice ID for a unique experience.</li>
                    <li><strong>‚öôÔ∏è Advanced Settings:</strong> Click the "Settings" button to:
                        <ul>
                            <li>Override default API keys for OpenAI and ElevenLabs.</li>
                            <li>Provide custom instructions to modify Ambit's behavior for the session.</li>
                        </ul>
                    </li>
                </ul>
            </div>

            <div class="info-section">
                <h3>ü§ñ Special Functions (Tool Calling)</h3>
                <p>You can trigger special functions by asking certain questions:</p>
                <ul>
                    <li><strong>Facial Recognition:</strong> Ask <em>"Who am I?"</em> or <em>"Do you recognize me?"</em> Ambit will use your webcam to identify you. If you're a new user, it will ask for your name and remember you.</li>
                    <li><strong>Vision Analysis:</strong> Ask Ambit to look at something, e.g., <em>"What do you think of this?"</em> or <em>"Can you see this?"</em> It will capture an image from your webcam and describe what it sees.</li>
                    <li><strong>Play Favorite Song:</strong> Ask <em>"What's your favorite song?"</em> Ambit will give a short intro and then play its favorite track.</li>
                </ul>
            </div>

             <div class="info-section">
                <h3>üîÑ Other Controls</h3>
                <ul>
                    <li><strong>Reset Conversation:</strong> Clears the AI's short-term memory of the current conversation but keeps the visual log on screen.</li>
                    <li><strong>Clear Log:</strong> Wipes the conversation log from the screen.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div class="modal-backdrop" id="modalBackdrop"></div>

    <script>
        class AmbitWebGUI {
            constructor() {
                this.websocket = null;
                this.isConnected = false;
                this.isVoiceEnabled = false;
                this.isRecording = false;
                this.conversationStarted = false;
                
                // WebRTC Audio
                this.mediaStream = null;
                this.audioContext = null;
                this.processor = null;
                this.silenceCounter = 0;
                this.speechCounter = 0;
                this.inSpeech = false;
                this.vadThreshold = 0.6;
                this.currentAudio = null;
                
                this.animationFrameId = null;
                this.canvasCtx = null;
                this.waveAmplitude = 0;
                this.targetAmplitude = 0;
                this.wavePhase = 0;
                
                this.initializeElements();
                this.setupEventListeners();
                this.setupAudioVisualization();
                this.loadSettings();
            }

            initializeElements() {
                // Main elements
                this.startConvoBtn = document.getElementById('startConvoBtn');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.audioViz = document.getElementById('audioViz');
                this.audioCanvas = document.getElementById('audioCanvas');
                this.vizOverlay = document.getElementById('vizOverlay');
                
                // Control elements
                this.resetConvoBtn = document.getElementById('resetConvoBtn');
                this.clearLogBtn = document.getElementById('clearLogBtn');
                this.voiceSettingsBtn = document.getElementById('voiceSettingsBtn');
                this.infoBtn = document.getElementById('infoBtn');
                
                // Modal elements
                this.modalBackdrop = document.getElementById('modalBackdrop');
                
                // Voice settings elements
                this.voiceSettingsPanel = document.getElementById('voiceSettingsPanel');
                this.voicePresetRadios = document.querySelectorAll('input[name="voicePreset"]');
                this.customVoiceInput = document.getElementById('customVoiceId');
                this.applyVoiceBtn = document.getElementById('applyVoiceBtn');
                this.closeVoiceBtn = document.getElementById('closeVoiceBtn');
                this.infoPanel = document.getElementById('infoPanel');
                
                // Settings elements
                this.advancedToggle = document.getElementById('advancedToggle');
                this.advancedSettings = document.getElementById('advancedSettings');
                
                // Advanced settings elements
                this.openaiApiKeyInput = document.getElementById('openaiApiKey');
                this.elevenlabsApiKeyInput = document.getElementById('elevenlabsApiKey');
                this.customInstructionsTextarea = document.getElementById('customInstructions');
                this.saveAdvancedBtn = document.getElementById('saveAdvancedBtn');
                this.resetAdvancedBtn = document.getElementById('resetAdvancedBtn');
                this.saveIndicator = document.getElementById('saveIndicator');
                
                // Conversation elements
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.conversationLog = document.getElementById('conversationLog');
            }

            setupEventListeners() {
                // Main start button
                this.startConvoBtn.addEventListener('click', () => this.startConversation());
                
                // Control buttons
                this.resetConvoBtn.addEventListener('click', () => this.resetConversation());
                this.clearLogBtn.addEventListener('click', () => this.clearLog());
                this.voiceSettingsBtn.addEventListener('click', () => this.openVoiceSettings());
                this.infoBtn.addEventListener('click', () => this.openInfoPanel());
                
                // Modal backdrop - close modals when clicked
                this.modalBackdrop.addEventListener('click', () => this.closeAllModals());
                
                // Voice settings panel
                this.applyVoiceBtn.addEventListener('click', () => this.applyVoiceSelection());
                this.closeVoiceBtn.addEventListener('click', () => this.closeAllModals());
                
                // Voice preset radio buttons
                this.voicePresetRadios.forEach(radio => {
                    radio.addEventListener('change', () => this.handleVoicePresetChange());
                });
                
                // Advanced settings toggle
                this.advancedToggle.addEventListener('click', () => this.openAdvancedSettings());
                
                // Advanced settings buttons
                this.saveAdvancedBtn.addEventListener('click', () => this.saveAdvancedSettings());
                this.resetAdvancedBtn.addEventListener('click', () => this.resetAdvancedSettings());
                
                // ESC key to close modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });
                
                // Message input
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
                this.sendBtn.addEventListener('click', () => this.sendMessage());
            }

            setupAudioVisualization() {
                // Initialize audio visualization immediately since it's always visible
                setTimeout(() => {
                    this.canvasCtx = this.audioCanvas.getContext('2d');
                    if (!this.canvasCtx) {
                        console.error("Failed to get canvas context");
                        return;
                    }
                    this.audioCanvas.width = this.audioCanvas.offsetWidth;
                    this.audioCanvas.height = this.audioCanvas.offsetHeight;
                    this.waveAmplitude = 0;
                    this.targetAmplitude = 5; // Small idle animation
                    this.wavePhase = 0;
                    this.renderWave(); // Start rendering loop immediately
                }, 100);
            }

            loadSettings() {
                const savedVoiceId = localStorage.getItem('ambit_voice_id');
                if (savedVoiceId) {
                    // Set the correct radio button based on saved voice ID
                    const matchingRadio = document.querySelector(`input[name="voicePreset"][value="${savedVoiceId}"]`);
                    if (matchingRadio) {
                        matchingRadio.checked = true;
                    } else {
                        // If it's a custom voice ID, select custom option and populate the input
                        const customRadio = document.querySelector('input[name="voicePreset"][value="custom"]');
                        if (customRadio) {
                            customRadio.checked = true;
                            this.customVoiceInput.value = savedVoiceId;
                            this.customVoiceInput.disabled = false;
                        }
                    }
                }

                // Load advanced settings
                const savedOpenAIKey = localStorage.getItem('ambit_openai_key');
                if (savedOpenAIKey) {
                    this.openaiApiKeyInput.value = savedOpenAIKey;
                }

                const savedElevenLabsKey = localStorage.getItem('ambit_elevenlabs_key');
                if (savedElevenLabsKey) {
                    this.elevenlabsApiKeyInput.value = savedElevenLabsKey;
                }

                const savedCustomInstructions = localStorage.getItem('ambit_custom_instructions');
                if (savedCustomInstructions) {
                    this.customInstructionsTextarea.value = savedCustomInstructions;
                }
            }

            openAdvancedSettings() {
                this.showModal(this.advancedSettings);
                this.log('‚öôÔ∏è Advanced settings opened', 'system');
            }

            async startConversation() {
                if (this.conversationStarted) {
                    this.stopConversation();
                    return;
                }

                try {
                    this.startConvoBtn.disabled = true;
                    this.startConvoBtn.innerHTML = 'üîÑ Starting...';
                    this.updateStatus('Connecting to Ambit AI...', 'connecting');

                    // Step 1: Connect to backend
                    await this.connect();
                    
                    // Step 2: Enable voice automatically
                    await this.enableVoice();
                    
                    // Step 3: Start WebRTC audio
                    await this.startWebRTCAudio();
                    
                    // Step 4: Send initial configuration to backend
                    const initialSettings = this.getAdvancedSettings();
                    this.websocket.send(JSON.stringify({
                        type: 'configure',
                        voiceId: initialSettings.voiceId,
                        customInstructions: initialSettings.customInstructions,
                        openaiApiKey: initialSettings.openaiApiKey,
                        elevenlabsApiKey: initialSettings.elevenlabsApiKey,
                        maxTokens: initialSettings.maxTokens
                    }));
                    
                    // Update UI for active conversation
                    this.conversationStarted = true;
                    this.startConvoBtn.innerHTML = '‚èπÔ∏è Stop Conversation';
                    this.startConvoBtn.disabled = false;
                    
                    // Enable control buttons
                    this.resetConvoBtn.disabled = false;
                    this.clearLogBtn.disabled = false;
                    
                    // Hide the overlay text on the visualizer
                    this.vizOverlay.style.display = 'none';

                    this.updateStatus('üé§ Listening... Speak now!', 'connected');
                    
                    this.log('‚úÖ Conversation started! You can now speak or type.', 'system');
                    
                    // Show active settings
                    const settings = this.getAdvancedSettings();
                    const voiceName = localStorage.getItem('ambit_voice_name') || 'AMBIT (Default)';
                    this.log(`üé§ Using voice: ${voiceName}`, 'system');
                    
                    if (settings.customInstructions) {
                        this.log(`üìù Custom instructions active (${settings.customInstructions.length} chars)`, 'system');
                    }
                    
                    if (settings.openaiApiKey) {
                        this.log(`üîë Using custom OpenAI API key`, 'system');
                    }
                    
                    if (settings.elevenlabsApiKey) {
                        this.log(`üîë Using custom ElevenLabs API key`, 'system');
                    }
                    
                } catch (error) {
                    this.log(`‚ùå Failed to start conversation: ${error.message}`, 'error');
                    this.updateStatus('Failed to start - Try again', 'disconnected');
                    this.startConvoBtn.innerHTML = 'üöÄ Start Conversation';
                    this.startConvoBtn.disabled = false;
                }
            }

            stopConversation() {
                this.conversationStarted = false;
                this.stopWebRTCAudio();
                
                if (this.websocket) {
                    this.websocket.close();
                }
                
                this.startConvoBtn.innerHTML = 'üöÄ Start Conversation';
                this.updateStatus('Conversation stopped', 'disconnected');
                this.messageInput.disabled = true;
                this.sendBtn.disabled = true;
                
                // Disable control buttons
                this.resetConvoBtn.disabled = true;
                this.clearLogBtn.disabled = true;
                
                // Show the overlay text on the visualizer again
                this.vizOverlay.style.display = 'flex';
                
                // Reduce animation amplitude for idle state
                this.targetAmplitude = 5;
                
                this.log('‚èπÔ∏è Conversation stopped', 'system');
            }

            updateStatus(message, type) {
                const dot = this.statusIndicator.querySelector('.connection-dot');
                dot.className = `connection-dot dot-${type}`;
                this.statusIndicator.innerHTML = `<span class="connection-dot dot-${type}"></span>${message}`;
            }

            log(message, type = 'system') {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('conversationLog');
                const messageClass = `message-${type}`;
                logElement.innerHTML += `<div class="${messageClass}">[${timestamp}] ${message}</div>`;
                logElement.scrollTop = logElement.scrollHeight;
            }

            async connect() {
                return new Promise((resolve, reject) => {
                    try {
                        this.websocket = new WebSocket('ws://localhost:8765');
                        
                        this.websocket.onopen = () => {
                            this.isConnected = true;
                            this.messageInput.disabled = false;
                            this.sendBtn.disabled = false;
                            resolve();
                        };
                        
                        this.websocket.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        };
                        
                        this.websocket.onclose = () => {
                            this.isConnected = false;
                            if (this.conversationStarted) {
                                this.stopConversation();
                            }
                        };
                        
                        this.websocket.onerror = (error) => {
                            reject(new Error('Connection failed'));
                        };
                        
                        // Timeout after 5 seconds
                        setTimeout(() => {
                            if (!this.isConnected) {
                                reject(new Error('Connection timeout'));
                            }
                        }, 5000);
                        
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            async enableVoice() {
                this.isVoiceEnabled = true;
                // Voice is automatically enabled
            }

            async startWebRTCAudio() {
                try {
                    // Request microphone with WebRTC AEC
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 16000,
                            channelCount: 1
                        }
                    });
                    
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });
                    
                    const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                    this.processor = this.audioContext.createScriptProcessor(4096, 1, 1);
                    
                    this.processor.onaudioprocess = (event) => this.processAudio(event);
                    source.connect(this.processor);
                    this.processor.connect(this.audioContext.destination);
                    
                    this.isRecording = true;
                    
                } catch (error) {
                    throw new Error(`Microphone access failed: ${error.message}`);
                }
            }

            processAudio(event) {
                if (!this.isRecording) return;
                
                const audioData = event.inputBuffer.getChannelData(0);
                const audioLevel = this.calculateAudioLevel(audioData);
                this.targetAmplitude = audioLevel * 300; // Adjust sensitivity
                
                // Send continuous audio stream to backend for Silero VAD processing
                this.sendAudioStream(audioData);
                
                // Update status based on audio activity (visual feedback only)
                if (audioLevel > this.vadThreshold) {
                    if (!this.inSpeech) {
                        this.inSpeech = true;
                        this.updateStatus('üó£Ô∏è Speaking detected...', 'connecting');
                    }
                    this.speechCounter++;
                    this.silenceCounter = 0;
                } else {
                    this.silenceCounter++;
                    this.speechCounter = 0;
                    
                    if (this.inSpeech && this.silenceCounter > 10) {
                        this.inSpeech = false;
                        this.updateStatus('üé§ Listening... Speak now!', 'connected');
                    }
                }
            }

            calculateAudioLevel(audioData) {
                let sum = 0;
                for (let i = 0; i < audioData.length; i++) {
                    sum += audioData[i] * audioData[i];
                }
                return Math.sqrt(sum / audioData.length);
            }

            renderWave() {
                this.animationFrameId = requestAnimationFrame(() => this.renderWave());
                if (!this.canvasCtx) return;

                // Smoothly transition current amplitude to the target
                this.waveAmplitude += (this.targetAmplitude - this.waveAmplitude) * 0.1;
                this.waveAmplitude = Math.max(0, this.waveAmplitude);

                const width = this.audioCanvas.width;
                const height = this.audioCanvas.height;
                this.canvasCtx.clearRect(0, 0, width, height);

                this.wavePhase += 0.05; // Speed of the wave animation

                this.canvasCtx.lineWidth = 2;

                // Draw multiple waves for a layered effect
                const waveColors = ['rgb(0, 122, 255)', 'rgb(52, 199, 89)', 'rgb(255, 59, 48)'];

                for (let i = 0; i < waveColors.length; i++) {
                    const color = waveColors[i];
                    const amplitudeMultiplier = 1 - (i / 4);
                    const waveComplexity = 2 + i * 0.8;

                    const path = new Path2D();
                    for (let x = 0; x < width; x++) {
                        const angle = this.wavePhase * (1 + i * 0.2) + (x / width) * Math.PI * 2 * waveComplexity;
                        const detailAngle = this.wavePhase * (2.5 + i) + (x / width) * Math.PI * (6 + i);
                        
                        const yOffset = Math.sin(angle) * this.waveAmplitude * amplitudeMultiplier;
                        const detailOffset = Math.sin(detailAngle) * (this.waveAmplitude / 3) * amplitudeMultiplier;

                        const y = height / 2 + yOffset + detailOffset;

                        if (x === 0) {
                            path.moveTo(x, y);
                        } else {
                            path.lineTo(x, y);
                        }
                    }

                    // 1. Draw Glow
                    this.canvasCtx.strokeStyle = color;
                    this.canvasCtx.lineWidth = 5;
                    this.canvasCtx.filter = 'blur(10px)';
                    this.canvasCtx.stroke(path);
                    
                    // 2. Draw main line on top
                    this.canvasCtx.lineWidth = 2;
                    this.canvasCtx.filter = 'none';
                    this.canvasCtx.stroke(path);
                }
            }

            sendAudioStream(audioData) {
                if (!this.isConnected) return;
                
                // Send continuous audio chunks for Silero VAD processing
                const audioArray = new Float32Array(audioData);
                const audioBytes = new Uint8Array(audioArray.buffer);
                const audioBase64 = btoa(String.fromCharCode(...audioBytes));
                
                // Get all current settings including voice and custom instructions
                const settings = this.getAdvancedSettings();
                
                this.websocket.send(JSON.stringify({
                    type: 'audio_stream',
                    data: audioBase64,
                    sampleRate: 16000,
                    voiceId: settings.voiceId,
                    customInstructions: settings.customInstructions,
                    openaiApiKey: settings.openaiApiKey,
                    elevenlabsApiKey: settings.elevenlabsApiKey,
                    maxTokens: settings.maxTokens
                }));
            }

            sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.isConnected) return;
                
                this.messageInput.value = '';
                this.log(`üë§ You: ${message}`, 'user');
                
                // Get all current settings including voice and custom instructions
                const settings = this.getAdvancedSettings();
                
                this.websocket.send(JSON.stringify({
                    type: 'message',
                    text: message,
                    voiceId: settings.voiceId,
                    customInstructions: settings.customInstructions,
                    openaiApiKey: settings.openaiApiKey,
                    elevenlabsApiKey: settings.elevenlabsApiKey,
                    maxTokens: settings.maxTokens
                }));
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'transcription':
                        this.log(`üé§ You said: "${data.text}"`, 'voice');
                        break;
                    case 'response':
                        this.log(`ü§ñ Ambit: ${data.text}`, 'ambit');
                        break;
                    case 'audio_ready':
                        this.log(`üîä Playing AI response...`, 'system');
                        this.playAudio(data.audioUrl);
                        break;
                    case 'cancel_audio':
                        this.cancelCurrentAudio();
                        break;
                    case 'error':
                        this.log(`‚ùå Error: ${data.message}`, 'error');
                        break;
                    case 'status':
                        this.log(`‚ÑπÔ∏è ${data.message}`, 'system');
                        break;
                }
            }

            playAudio(audioUrl) {
                this.cancelCurrentAudio(); // Ensure any previous audio is stopped
                
                const audio = new Audio(audioUrl);
                this.currentAudio = audio;
                
                audio.play().catch(e => {
                    console.error("Audio playback failed:", e);
                    this.log('Could not play audio. Please interact with the page first.', 'error');
                    if (this.currentAudio === audio) {
                        this.currentAudio = null;
                    }
                });

                audio.onended = () => {
                    if (this.currentAudio === audio) {
                        this.currentAudio = null;
                        this.updateStatus('üé§ Listening... Speak now!', 'connected');
                        console.log("Audio playback finished.");
                    }
                };
            }

            cancelCurrentAudio() {
                if (this.currentAudio) {
                    console.log("Cancelling current audio playback.");
                    this.log("Playback interrupted by user.", "system");
                    this.currentAudio.pause();
                    this.currentAudio.src = ''; // Release the audio resource
                    this.currentAudio = null;
                    this.updateStatus('üé§ Listening... Speak now!', 'connected');
                }
            }

            resetConversation() {
                if (this.conversationStarted) {
                    this.stopConversation();
                }
                
                // Clear conversation log
                this.conversationLog.innerHTML = `
                    <div class="message-system">[System] Welcome to Ambit AI</div>
                    <div class="message-system">[System] Click "Start Conversation" to begin</div>
                `;
                
                // Reset any saved settings if needed
                this.log('üîÑ Conversation reset', 'system');
            }

            clearLog() {
                // Clear only the conversation log content
                this.conversationLog.innerHTML = `
                    <div class="message-system">[System] Log cleared</div>
                `;
                this.log('üóëÔ∏è Log cleared', 'system');
            }

            openVoiceSettings() {
                this.showModal(this.voiceSettingsPanel);
                this.log('üé§ Voice settings opened', 'system');
            }

            closeAllModals(silent = false) {
                // Hide backdrop
                this.modalBackdrop.classList.remove('show');
                
                // Hide all modals
                const modals = [this.voiceSettingsPanel, this.advancedSettings, this.infoPanel];
                modals.forEach(modal => {
                    modal.classList.remove('show');
                });
                
                // Restore body scroll and remove blur from container
                document.body.style.overflow = '';
                document.querySelector('.container').classList.remove('modal-open');
                
                if (!silent) {
                    this.log('Settings closed', 'system');
                }
            }

            showModal(modalElement) {
                // Close any open modals first
                this.closeAllModals(true);
                
                // Show backdrop and modal
                this.modalBackdrop.classList.add('show');
                modalElement.classList.add('show');
                
                // Prevent body scroll and blur the container
                document.body.style.overflow = 'hidden';
                document.querySelector('.container').classList.add('modal-open');
            }

            handleVoicePresetChange() {
                const selectedVoice = document.querySelector('input[name="voicePreset"]:checked');
                if (selectedVoice) {
                    if (selectedVoice.value === 'custom') {
                        // Enable custom voice input
                        this.customVoiceInput.disabled = false;
                        this.customVoiceInput.focus();
                    } else {
                        // Disable custom voice input
                        this.customVoiceInput.disabled = true;
                        this.customVoiceInput.value = '';
                    }
                }
            }

            applyVoiceSelection() {
                const selectedVoice = document.querySelector('input[name="voicePreset"]:checked');
                if (!selectedVoice) {
                    this.log('‚ùå Please select a voice option', 'error');
                    return;
                }

                let voiceId;
                let voiceName;

                if (selectedVoice.value === 'custom') {
                    voiceId = this.customVoiceInput.value.trim();
                    if (!voiceId) {
                        this.log('‚ùå Please enter a custom voice ID', 'error');
                        return;
                    }
                    voiceName = 'Custom Voice';
                } else {
                    voiceId = selectedVoice.value;
                    voiceName = selectedVoice.parentElement.querySelector('.voice-name').textContent;
                }

                // Save to localStorage
                localStorage.setItem('ambit_voice_id', voiceId);
                localStorage.setItem('ambit_voice_name', voiceName);

                // Close the voice settings panel
                this.closeAllModals();

                this.log(`üé§ Voice changed to: ${voiceName} (ID: ${voiceId})`, 'system');
                console.log('Voice saved:', { voiceName, voiceId });
            }

            saveAdvancedSettings() {
                // Save API keys (only if they have values)
                const openaiKey = this.openaiApiKeyInput.value.trim();
                if (openaiKey) {
                    localStorage.setItem('ambit_openai_key', openaiKey);
                } else {
                    localStorage.removeItem('ambit_openai_key');
                }

                const elevenlabsKey = this.elevenlabsApiKeyInput.value.trim();
                if (elevenlabsKey) {
                    localStorage.setItem('ambit_elevenlabs_key', elevenlabsKey);
                } else {
                    localStorage.removeItem('ambit_elevenlabs_key');
                }

                // Save custom instructions
                const customInstructions = this.customInstructionsTextarea.value.trim();
                if (customInstructions) {
                    localStorage.setItem('ambit_custom_instructions', customInstructions);
                } else {
                    localStorage.removeItem('ambit_custom_instructions');
                }

                // Show save indicator with animation
                this.saveIndicator.classList.add('show');
                
                // Change button temporarily to show saved state
                const originalText = this.saveAdvancedBtn.innerHTML;
                this.saveAdvancedBtn.innerHTML = '‚úÖ Saved!';
                this.saveAdvancedBtn.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
                
                // Hide indicator and reset button after 3 seconds
                setTimeout(() => {
                    this.saveIndicator.classList.remove('show');
                    this.saveAdvancedBtn.innerHTML = originalText;
                    this.saveAdvancedBtn.style.background = '';
                }, 3000);

                this.log('üíæ Advanced settings saved successfully!', 'system');
                this.log('‚úÖ API keys and custom instructions will override defaults', 'system');
            }

            resetAdvancedSettings() {
                // Clear all advanced settings
                this.openaiApiKeyInput.value = '';
                this.elevenlabsApiKeyInput.value = '';
                this.customInstructionsTextarea.value = '';

                // Remove from localStorage
                localStorage.removeItem('ambit_openai_key');
                localStorage.removeItem('ambit_elevenlabs_key');
                localStorage.removeItem('ambit_custom_instructions');

                // Show reset confirmation
                const originalText = this.resetAdvancedBtn.innerHTML;
                this.resetAdvancedBtn.innerHTML = '‚úÖ Reset!';
                this.resetAdvancedBtn.style.background = 'linear-gradient(135deg, #6b7280 0%, #9ca3af 100%)';
                
                setTimeout(() => {
                    this.resetAdvancedBtn.innerHTML = originalText;
                    this.resetAdvancedBtn.style.background = '';
                }, 2000);

                this.log('üîÑ Advanced settings reset to defaults', 'system');
                this.log('‚ÑπÔ∏è Using default API keys and instructions', 'system');
            }

            getAdvancedSettings() {
                // Get voice ID from localStorage (set by voice settings panel)
                const voiceId = localStorage.getItem('ambit_voice_id') || 'd2dPVWorYGa7CSQb2jt3';
                
                // Get saved values or current input values
                const openaiKey = this.openaiApiKeyInput?.value?.trim() || 
                                  localStorage.getItem('ambit_openai_key') || 
                                  null;
                
                const elevenlabsKey = this.elevenlabsApiKeyInput?.value?.trim() || 
                                      localStorage.getItem('ambit_elevenlabs_key') || 
                                      null;
                
                const customInstructions = this.customInstructionsTextarea?.value?.trim() || 
                                          localStorage.getItem('ambit_custom_instructions') || 
                                          null;
                
                const settings = {
                    // These will override backend defaults when provided
                    openaiApiKey: openaiKey,
                    elevenlabsApiKey: elevenlabsKey,
                    customInstructions: customInstructions,
                    voiceId: voiceId,
                    maxTokens: 150  // Default tokens
                };
                
                // Debug log to verify settings
                console.log('Advanced settings being sent:', {
                    voiceId: settings.voiceId,
                    hasCustomInstructions: !!settings.customInstructions,
                    customInstructionsLength: settings.customInstructions?.length || 0,
                    hasOpenAIKey: !!settings.openaiApiKey,
                    hasElevenLabsKey: !!settings.elevenlabsApiKey
                });
                
                return settings;
            }

            stopWebRTCAudio() {
                this.isRecording = false;
                
                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                }
                if (this.processor) {
                    this.processor.disconnect();
                }
                if (this.audioContext) {
                    this.audioContext.close();
                }
            }

            openInfoPanel() {
                this.showModal(this.infoPanel);
                this.log('‚ùì Info panel opened', 'system');
            }
        }

        // Initialize the app
        const app = new AmbitWebGUI();
    </script>
</body>
</html>